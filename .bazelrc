import %workspace%/tools/preset.bazelrc
try-import %workspace%/tools/java17.bazelrc

### YOUR PROJECT SPECIFIC OPTIONS GO HERE ###

startup --quiet

# C++ standard selection (default C++20, with a C++17 override).
common --config=cxx20
common:cxx17 --cxxopt=-std=c++17
common:cxx17 --host_cxxopt=-std=c++17
common:cxx20 --cxxopt=-std=c++20
common:cxx20 --host_cxxopt=-std=c++20

# Disable skymeld; see https://github.com/bazelbuild/bazel/issues/23743
# fixes src/main/tools/process-wrapper-legacy.cc:80: "execvp(external/++toolchains+coreutils_linux_amd64/coreutils, ...)": No such file or directory
common --noexperimental_merged_skyframe_analysis_execution

# also see: https://blog.aspect.build/configuring-bazels-downloader
common --downloader_config=tools/downloader.cfg

# rules_python is working to enable this default to avoid dependency on a system interpreter
# See https://github.com/bazel-contrib/rules_python/issues/3187
# NB: some tools run py_binary targets even if the user didn't select to add Python to their project
common --@rules_python//python/config_settings:bootstrap_impl=script
common --workspace_status_command=githooks/check-config.sh



common:lint --aspects=//tools/lint:linters.bzl%clang_tidy

# ---- Sanitizers (clang/toolchains_llvm) ----
# Shared sanitizer defaults.
build:san-common --strip=never
build:san-common -c dbg
build:san-common --copt=-O1
build:san-common --copt=-fno-omit-frame-pointer
build:san-common --linkopt=-fno-omit-frame-pointer

# ---- ASan ----
build:asan --config=san-common
build:asan --copt=-fsanitize=address
build:asan --linkopt=-fsanitize=address
test:asan  --test_env=ASAN_OPTIONS=halt_on_error=1:abort_on_error=1

# ---- UBSan ----
build:ubsan --config=san-common
build:ubsan --copt=-fsanitize=undefined
build:ubsan --linkopt=-fsanitize=undefined
build:ubsan --copt=-fno-sanitize-recover=all
test:ubsan  --test_env=UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1

# ---- TSan ----
build:tsan --config=san-common
build:tsan --copt=-fsanitize=thread
build:tsan --linkopt=-fsanitize=thread
test:tsan  --test_env=TSAN_OPTIONS=halt_on_error=1

# macOS: run tests under a wrapper that stages sanitizer runtimes next to the binary.
test:macos --run_under=//tools/sanitizers:darwin_san_run_under


# Load any settings & overrides specific to the current user from `.aspect/bazelrc/user.bazelrc`.
# This file should appear in `.gitignore` so that settings are not shared with team members. This
# should be last statement in this config so the user configuration is able to overwrite flags from
# this file. See https://bazel.build/configure/best-practices#bazelrc-file.
try-import %workspace%/user.bazelrc
